---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Your Shopping Cart">
  <style>
      main {
          max-width: 900px;
          margin: auto;
          padding: 2rem;
          color: white;
      }

      h1 {
          font-size: 2.5rem;
          margin-bottom: 2rem;
          text-align: center;
      }

      .cart-items {
          list-style: none;
          padding: 0;
          margin: 0;
          border-top: 1px solid #333;
      }

      .cart-item-link {
          display: block;
          text-decoration: none;
          color: inherit;
          transition: background-color 0.2s;
      }

      .cart-item-link:hover {
          background-color: #1a2647;
      }

      .cart-item {
          display: flex;
          align-items: center;
          gap: 1.5rem;
          padding: 1.5rem;
          border-bottom: 1px solid #333;
      }

      .cart-item img {
          width: 80px;
          height: 80px;
          object-fit: cover;
          border-radius: 8px;
      }

      .item-details {
          flex-grow: 1;
      }

      .item-title {
          font-size: 1.2rem;
          font-weight: bold;
          margin: 0;
      }

      .item-price {
          color: #a0a0a0;
      }

      .item-quantity {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .item-quantity label {
          font-size: 0.9rem;
      }

      .quantity-input {
          width: 60px;
          padding: 0.5rem;
          text-align: center;
          border-radius: 4px;
          border: 1px solid #ccc;
          color: white;
      }

      .empty-cart-message {
          text-align: center;
          font-size: 1.2rem;
          padding: 3rem 0;
      }

      .cart-actions {
          margin-top: 2rem;
          text-align: center;
      }

      .clear-cart-button {
          background-color: var(--accent-dark);
          color: white;
          border: none;
          padding: 0.75rem 1.5rem;
          font-size: 1rem;
          border-radius: 4px;
          cursor: pointer;
      }
  </style>

  <main>
    <h1>Your Cart</h1>
    <div id="cart-container">
      <!-- Cart items will be rendered here by the script -->
    </div>
    <div class="cart-actions">
      <button
          id="clear-cart"
          class="clear-cart-button"
      >Clear Cart
      </button>
    </div>
  </main>

  <template id="cart-item-template">
    <li class="cart-item">
      <a class="cart-item-link-img">
        <img
            src=""
            alt=""
        />
      </a>
      <div class="item-details">
        <a class="cart-item-link-title">
          <p class="item-title"></p>
        </a>
        <p class="item-price"></p>
      </div>
      <div class="item-quantity">
        <label>Qty:</label>
        <input
            type="number"
            class="quantity-input"
            min="0"
        />
      </div>
    </li>
  </template>

  <script type="module">
      import {cart, clearCart, updateItemQuantity} from '/src/lib/cart-store.js';

      const cartContainer = document.getElementById('cart-container');
      const itemTemplate = document.getElementById('cart-item-template');
      const clearCartButton = document.getElementById('clear-cart');

      function renderCart(items) {
          cartContainer.innerHTML = '';

          if (items.length === 0) {
              cartContainer.innerHTML = '<p class="empty-cart-message">Your cart is empty.</p>';
              return;
          }

          const itemList = document.createElement('ul');
          itemList.className = 'cart-items';

          items.forEach(item => {
              const itemClone = itemTemplate.content.cloneNode(true);
              const imgLink = itemClone.querySelector('.cart-item-link-img');
              const titleLink = itemClone.querySelector('.cart-item-link-title');
              const img = itemClone.querySelector('img');
              const quantityInput = itemClone.querySelector('.quantity-input');

              const itemPageUrl = `/parts/${item.handle}`;

              imgLink.href = itemPageUrl;
              titleLink.href = itemPageUrl;

              img.src = item.image;
              img.alt = item.title;
              itemClone.querySelector('.item-title').textContent = item.title;
              itemClone.querySelector('.item-price').textContent = new Intl.NumberFormat('en-US', {
                  style: 'currency',
                  currency: item.currency || 'USD'
              }).format(item.price);

              quantityInput.value = item.quantity;
              quantityInput.dataset.itemId = item.id;

              itemList.appendChild(itemClone);
          });

          cartContainer.appendChild(itemList);
      }

      // Event Delegation for quantity updates
      cartContainer.addEventListener('input', event => {
          if (event.target.classList.contains('quantity-input')) {
              const itemId = event.target.dataset.itemId;
              const newQuantity = parseInt(event.target.value, 10);

              if (!isNaN(newQuantity)) {
                  updateItemQuantity(itemId, newQuantity);
              }
          }
      });

      clearCartButton.addEventListener('click', () => {
          clearCart();
      });

      cart.subscribe(renderCart);
  </script>
</Layout>